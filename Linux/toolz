#!/bin/bash

# =============================================================================
# Toolz - Multi-Tool Bash Utility
# Author: Sivan Monshi
# Description: This script provides multiple system management functionalities.
# =============================================================================

find_helper() {
  echo "Enter the directory to search in:"
  read directory
  if [[ ! -d "$directory" ]]; then
    echo "Invalid directory."
    exit 1
  fi

  echo "Enter the search pattern (e.g., '*.txt'):"
  read pattern

  echo "Searching for files..."
  find "$directory" -name "$pattern"
}

system_info() {
  echo "Memory Usage:"
  free -h
  echo

  echo "Running Processes:"
  ps aux | wc -l
  echo

  echo "Disk Usage:"
  df -h
}

process_management() {
  echo "Sort processes by: (1) CPU (2) Memory"
  read choice

  case $choice in
    1) sort_by="%cpu" ;;
    2) sort_by="%mem" ;;
    3) sort_by="start_time" ;;
    *) echo "Invalid choice"; exit 1 ;;
  esac

  echo "===== Top Processes ====="
  printf "%-10s %-8s %-6s %-6s %-30s\n" "USER" "PID" "%CPU" "%MEM" "COMMAND"

  ps -eo user:10,pid,%cpu,%mem,comm --sort=-$sort_by | \
    awk 'NR>1 { printf "%-10s %-8s %-6s %-6s %-30.30s\n", $1, $2, $3, $4, $5 }' | \
    head -n 11

  echo "Enter PID to kill (or press Enter to skip):"
  read pid
  if [[ ! -z "$pid" ]]; then
    kill "$pid"
    echo "Process $pid killed."
  fi
}

user_management() {
  echo "Currently logged-in users:"
  who
  echo

  echo "User sessions and activities:"
  w
  echo

  echo "Recent logins:"
  last | head
}

network_info() {
  echo "===== Network Information ====="
  ip addr show
  echo

  echo "===== Active Connections ====="
  ss -tunap | head -n 20
}

service_list() {
  echo "===== Service Status Table ====="
  printf "%-45s %-10s %-10s %-10s\n" "SERVICE" "LOAD" "ACTIVE" "SUB"

  systemctl list-units --type=service --no-pager --no-legend | while read -r line; do
    service_name=$(echo "$line" | awk '{print $1}')
    load_status=$(echo "$line" | awk '{print $2}')
    active_status=$(echo "$line" | awk '{print $3}')
    sub_status=$(echo "$line" | awk '{print $4}')

    printf "%-45s %-10s %-10s %-10s\n" "$service_name" "$load_status" "$active_status" "$sub_status"
  done
}

cleanup_temp() {
  echo "Cleaning temporary files..."
  sudo rm -rf /tmp/*
  echo "Temporary files cleaned!"
}

check_sudo_users() {
  echo "===== Sudo Users ====="
  getent group sudo
}

disk_health() {
  echo "===== Disk Health ====="

  if ! command -v smartctl &> /dev/null; then
    echo "The 'smartctl' tool is not installed."
    echo "Do you want to install 'smartmontools'? (y/n)"
    read answer

    if [[ "$answer" == "y" || "$answer" == "Y" ]]; then
      sudo apt update
      sudo apt install -y smartmontools
    else
      echo "Cannot check disk health without 'smartctl'. Exiting."
      exit 1
    fi
  fi

  sudo smartctl -a /dev/sda
}


help_menu() {
  echo "Usage: $0 [options]"
  echo "-c    Clean Temp"
  echo "-d    Disk Health"
  echo "-f    Find Helper"
  echo "-l    Services Information"
  echo "-s    System Information"
  echo "-p    Process Management"
  echo "-u    User Management"
  echo "-v   Sudo Users"
  echo "-h    Help Menu"
  echo "-n    Network Info"
}

# Main Function
main() {
  while getopts ":cflnspuhvd" opt; do
    case $opt in
      c) cleanup_temp ;;
      d) disk_health ;;
      f) find_helper ;;
      l) service_list ;;
      n) network_info ;;
      s) system_info ;;
      p) process_management ;;
      u) user_management ;;
      v) check_sudo_users ;;
      h) help_menu ;;
      \?) echo "Invalid option: -$OPTARG" >&2; help_menu; exit 1 ;;
    esac
  done
}
main "$@"
